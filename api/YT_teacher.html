<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" href="../images/JS.png">
    <link href="../sss/inspector.css" rel="stylesheet" media="all">
    <script src="../sss/inspector.js"></script>
    <title>YouTube Teacher </title>

<style>
    body { max-width: 1000px; }
    #left { width: 420px; }
    #right { width: 560px; }
    #left, #right { display: inline-block; }
</style>
</head>

<body>
<div id=left>
  <h3 id=title></h3>
  <div id=sss></div>
  <pre id=msg></pre>
</div>
<div id=right>
  <iframe id=player frameborder=0 width=560 height=315 allowfullscreen
  allow="accelerometer; encrypted-media; gyroscope; picture-in-picture">
  </iframe>
  <hr>
  <p id=refs><b>Reference:</b> &emsp;
    <a href="https://developers.google.com/youtube/v3/docs/playlists" 
     target="NewTab">YouTube API playlists V3</a>
  </p>  
  <p><b>Problem:</b> Write two methods </p>
</div>
  <!-- <pre>
1. listFolder(fileId) List contents of given folder

2. move(fileId, parent) Move file/folder to new folder
  </pre> -->
  <br>

<script>
"use strict";
var a,b,c,s,t,id; //may be used in Inspector

class PlayList {
  constructor(title, id, chan, items) {
    this.title = title; this.id = id; this.channelTitle = chan
    this.items = setObjStr(items, items.length+' videos')
  }
  toString() { return this.title }
}

class VideoItem {
  constructor(title, id) {
    this.title = title; this.id = id
  }
  playItem() {
    log("playVideo "+this.id);
    const HREF = 'https://www.youtube.com/embed/'
    player.src = HREF+this.id
    player.scrollIntoView()
  }
  toString() { return this.title }
}

class GAPI_menu {
  constructor() {
    this.window = window
  }
  initGAPI() {
    if (window.gapi) throw "gapi is already initialized";
    log("1. Load and start GAPI");
    let e = document.createElement('script')
    e.onload = () => gapi.load("client", loadClient)
    document.body.append(e)
    e.src = "https://apis.google.com/js/api.js"
  }
  playVideo(id) {
    if (!id) id ='K4wNaM5FM2U'  //sample video
    new VideoItem('none', id).playItem()
  }
  async playlistItems(id, maxResults=30) {
    if (!id) id ='PLC20F52B96F3E8206'  //sample playlist
    log("Loading play list "+id)
    let part = "snippet"
    let r1 = await gapi.client.youtube.playlists.list({part, id})
    if (r1.status > 200)
      return new Promise((resolve, reject) => reject(r1.result))
    let [x] = r1.result.items
    let channelTitle = x.snippet.channelTitle
    let title = x.snippet.title
    let playlistId = id, arg = {part, maxResults, playlistId}
    let r2 = await gapi.client.youtube.playlistItems.list(arg)
    if (r2.status > 200)
      return new Promise((resolve, reject) => reject(r2.result))
    let a = r2.result.items.map(x =>  //getItems(r2)
      new VideoItem(x.snippet.title, x.snippet.resourceId.videoId))
    let p = new PlayList(title, id, channelTitle, a)
    console.log('getItems', r2)
    return new Promise((resolve) => resolve(p))
    //same as display(p) -- resolve is display
  }
  toString() { return "GAPI_menu" }
}

async function loadClient() { //called after initGAPI()
    log("2. Load YouTube client")
    const apiKey = 'AIzaSyCH22pYgwYoWme6CFPiU3i_JLD-SgATteU', YT = 
      "https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest";
    gapi.client.setApiKey(apiKey)
    await gapi.client.load(YT)
    //set MENU items
    addToMENU(gapi, 'gapi', 'gapi')
    setObjStr(gapi.client, 'gapi.client')
    setObjStr(gapi.client.youtube, 'gapi.client.youtube')
    let v = gapi.client.youtube.videos
    setObjStr(v, 'gapi.client.youtube.videos')
    let p = gapi.client.youtube.playlists
    setObjStr(p, 'gapi.client.youtube.playlists')
    let i = gapi.client.youtube.playlistItems
    setObjStr(i, 'gapi.client.youtube.playlistItems')
    // addToMENU(new YouTube_teacher(), 'teacher')
    msg.innerHTML = STAGE2
}
const STAGE0 = 
`When the page loads, gapi is not defined yet.

initGAPI() loads and initializes GAPI,
then calls loadClient() for YouTube.
Authorization step is not needed.

              Now click initGAPI()
              No arguments needed`
const STAGE2 = 
`YouTube client is loaded now. 

You may use these methods in any order:
* playVideo(videoId)
* playlistItems(playlistId, maxResults=30)`

function stringify(m) {
    if (typeof m === "string") return m
    return JSON.stringify(m,'',2)
}
function log(m) {
    let r = m.result || m
    console.log(m); out.style.color = ''
    out.innerText = stringify(r)
}
function setObjStr(obj, str=obj.name) {
    obj.toString = () => str  //used in display()
    return obj
}
function addToMENU(obj, name, str) {
    if (str) setObjStr(obj, str)
    MENU[name] = obj;  //display(obj)
}
    title.innerText = document.title
    msg.innerHTML = STAGE0
    MENU = new GAPI_menu(); //global
    inspect(sss); display(MENU);
</script>

</body>
</html>
