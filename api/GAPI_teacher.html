<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" href="../images/JS.png">
    <link href="../sss/inspector.css" rel="stylesheet" media="all">
    <script src="../sss/inspector.js"></script>
    <title>GAPI Teacher </title>

<style>
    img {
        position: fixed;
        top:8px; right:8px;
        width: 50px;
    }

</style>
</head>

<body>
    <h3 id=title></h3>
    <img id=image>
    <div id=sss></div>
<pre>
When the page loads, GAPI is not loaded yet.
Drive API will be ready in three stages:
1. initGAPI() loads and initializes GAPI
Location: apis.google.com/js/api.js 
2. signIn() gets authorization from a User account
(may be skipped if an account is already active)
3. loadClient() drive client will be used
Drive_teacher is displayed, with several methods:

createFile(name, mimeType, parent)

createFolder(name, parent)

find(name, type) => fileId

open(fileId)

rename (fileId, name)

upload(fileId, data)
</pre>
<script>
"use strict";
class Drive_teacher {
  constructor() {
    this.FOLDER = 'application/vnd.google-apps.folder'
    this.fields = 'files(id,name,mimeType,parents)'
    // this.fileId = (fileId) => ({fileId})
  }
  createFile(name, mimeType, parent) {
    log("create "+name);
    let resource = {name, mimeType}
    if (parentId) resource.parents = [parentId]
    return gapi.client.drive.files.create(resource)
  }
  createFolder(name, parent) {
    return createFile(name, this.FOLDER, parent) 
  }
  find(name, type) {
    log("find "+name)
    let q = "trashed=false and name='"+name+"'"
    if (type)
       q += " and mimeType contains '"+type+"'"
    return gapi.client.drive.files.list({q})
  }
  rename(fileId, name) {
    log("rename "+name)
    resource = {name}
    return gapi.client.drive.files.update({fileId, resource})
  }
  async open(fileId) {
    let fields = 'files(id,name,webViewLink)'
    let {result} = await gapi.client.drive.files.get({fileId, fields})
    if (result.id !== id) throw 'unexpected id '+result.id
    log("open "+result.name+" in another tab")
    open(result.webViewLink, "NewTab")
  }
  upload(id, body) {
    log("upload "+id) //requires low-level HTTP request
    let path = 'https://www.googleapis.com/upload/drive/v3/files/'+id
    let method = 'PATCH', params = {uploadType: 'media'}
    // let headers = {'Content-Type': mimeType}
    return gapi.client.request({path, method, params, body})
  }
  toString() { return "Drive_teacher" }
}

class GAPI_teacher {
  constructor() {
    this.window = window
  }
  s1_initGAPI() {
    if (window.gapi) throw "gapi already initialized";
    let e = document.createElement('script')
    e.onload = () => gapi.load("client:auth2", stage1)
    document.body.append(e)
    e.src = "https://apis.google.com/js/api.js"
  }
  s2_signIn() {
    log("2. Authorization");
    gapi.auth2.getAuthInstance().signIn().then(showProfile)
  }
  s3_loadClient() {
    const DRIVE = 
    "https://content.googleapis.com/discovery/v1/apis/drive/v3/rest"
    if (gapi.client.drive) stage3()
    else {
      log("3. Load drive client");
      gapi.client.load(DRIVE).then(stage3)
    }  
  }
  signOut() {
    gapi.auth2.getAuthInstance().signOut().then(log)
    image.src = ''; image.title = ''
  }
  toString() { return "GAPI_teacher" }
}

async function stage1() { //called after initGAPI()
    const
      apiKey = 'AIzaSyCH22pYgwYoWme6CFPiU3i_JLD-SgATteU',
      clientId = "864962883135-ut9cl3g1jlqv1frlp2p6cq9r3jsfflkv.apps.googleusercontent.com",
      scope = 'https://www.googleapis.com/auth/drive.file';
    await gapi.auth2.init({ apiKey, clientId, scope })
    addToMENU(gapi, 'gapi')
    if (currentUser().getId()) showProfile()
}
async function stage3() { //called after loadClient()
    log("3. Drive client is loaded")
    // if (Menu.client) return
    // addToMENU(gapi.client, 'client', 'gapi.client')
    // addToMENU(gapi.client.drive, 'drive', 'gapi.client.drive')
    // addToMENU(gapi.client.drive.files, 'files', 'gapi.client.drive.files')
    display(new Drive_teacher())
}

function stringify(m) {
    if (typeof m === "string") return m
    return JSON.stringify(m,'',2)
}
function log(m) {
    let r = m.result || m
    console.log(m); out.style.color = ''
    out.innerText = stringify(r)
}
function error(e) {
    let r = e.error || e.result ||  e
    console.error(e); out.style.color = 'red'
    out.innerText = stringify(r)
}
function addToMENU(obj, name, str=name) {
    obj.toString = () => str  //used in display()
    MENU[name] = obj; display(obj)
}
function currentUser() {
    return gapi.auth2.getAuthInstance().currentUser.get()
}
function showProfile() {
    let p = currentUser().getBasicProfile()
    image.src = p.getImageUrl()
    image.title = p.getName()+'\n'+p.getEmail()
    addToMENU(p, 'user', 'Profile')
}
    title.innerText = document.title
    MENU = new GAPI_teacher(); //global
    inspect(sss); display(MENU);
</script>

</body>
</html>
